@using frontend.Models
@inject IJSRuntime JS

<div class="modal-overlay" @onclick="OnClose">
    <div class="modal-content" @onclick:stopPropagation="true">
        <header class="modal-header">
            <h2>Request a Quote</h2>
            <button class="close-btn" @onclick="OnClose">&times;</button>
        </header>

        <form @onsubmit="HandleSubmit" @onsubmit:preventDefault>
            <div class="form-group">
                <label for="company">Company Name *</label>
                <input type="text" id="company" @bind="Quote.Company" required />
            </div>

            <div class="form-group">
                <label for="contact">Contact Name *</label>
                <input type="text" id="contact" @bind="Quote.Contact" required />
            </div>

            <div class="form-group">
                <label for="email">Email Address *</label>
                <input type="email" id="email" @bind="Quote.Email" required />
            </div>

            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" @bind="Quote.Phone" />
            </div>

            <div class="form-group">
                <label for="quantity">Number of Systems</label>
                <input type="number" id="quantity" min="1" @bind="Quote.Quantity" />
            </div>

            <div class="form-group">
                <label for="notes">Additional Notes</label>
                <textarea id="notes" rows="3" @bind="Quote.Notes"></textarea>
            </div>

            <div class="quote-summary">
                <h3>Configuration Summary</h3>
                @if (OverheadConfig != null)
                {
                    <dl>
                        <dt>Track Length</dt><dd>@OverheadConfig.TrackLength mm</dd>
                        <dt>Profile</dt><dd>@OverheadConfig.TrackProfile</dd>
                        <dt>Height</dt><dd>@OverheadConfig.HeightFromFloor mm</dd>
                        <dt>Carriers</dt><dd>@OverheadConfig.NumCarriers units</dd>
                        <dt>Load per Carrier</dt><dd>@OverheadConfig.LoadPerCarrier kg</dd>
                        <dt>Total Capacity</dt><dd>@(OverheadConfig.NumCarriers * OverheadConfig.LoadPerCarrier) kg</dd>
                        @if (OverheadConfig.IncludeCurves)
                        {
                            <dt>Curves</dt><dd>R@(OverheadConfig.CurveRadius)mm</dd>
                        }
                    </dl>
                }
            </div>

            @if (BomItems != null && BomItems.Any())
            {
                <div class="quote-summary">
                    <h3>Parts Summary (@BomItems.Count items)</h3>
                    <dl>
                        @foreach (var item in BomItems.Where(i => i.Quantity > 0))
                        {
                            <dt>@item.Description</dt>
                            <dd>@item.Quantity x @item.UnitPrice.ToString("C")</dd>
                        }
                        <dt><strong>Estimated Total</strong></dt>
                        <dd><strong>@BomItems.Sum(i => i.TotalPrice).ToString("C")</strong></dd>
                    </dl>
                </div>
            }

            <div class="modal-actions">
                <button type="button" class="btn-secondary" @onclick="OnClose">Cancel</button>
                <button type="button" class="btn-secondary" @onclick="ExportLocally" disabled="@IsSubmitting">
                    Export Locally
                </button>
                <button type="submit" class="btn-primary" disabled="@IsSubmitting">
                    @if (IsSubmitting)
                    {
                        <span>Submitting...</span>
                    }
                    else
                    {
                        <span>Submit Quote Request</span>
                    }
                </button>
            </div>
        </form>
    </div>
</div>

@code {
    [Parameter] public string ConveyorType { get; set; } = "overhead";
    [Parameter] public OverheadConveyorConfig? OverheadConfig { get; set; }
    [Parameter] public List<BomItem>? BomItems { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<QuoteRequest> OnSubmit { get; set; }

    private QuoteRequest Quote { get; set; } = new();
    private bool IsSubmitting { get; set; }

    private async Task HandleSubmit()
    {
        IsSubmitting = true;
        try
        {
            Quote.ConveyorType = ConveyorType;
            Quote.OverheadConfiguration = OverheadConfig;
            Quote.BomItems = BomItems;

            await OnSubmit.InvokeAsync(Quote);
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private async Task ExportLocally()
    {
        var quoteText = GenerateQuoteText();
        var fileName = $"quote_{DateTime.Now:yyyyMMdd_HHmmss}.txt";

        // Convert text to bytes and trigger download
        var bytes = System.Text.Encoding.UTF8.GetBytes(quoteText);
        var base64 = Convert.ToBase64String(bytes);

        await JS.InvokeVoidAsync("eval", $@"
            (function() {{
                const link = document.createElement('a');
                link.href = 'data:text/plain;base64,{base64}';
                link.download = '{fileName}';
                link.click();
            }})();
        ");
    }

    private string GenerateQuoteText()
    {
        var text = new System.Text.StringBuilder();

        text.AppendLine("================================================================================");
        text.AppendLine("                        CONVEYOR SYSTEM QUOTE REQUEST");
        text.AppendLine("================================================================================");
        text.AppendLine();
        text.AppendLine($"Generated: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
        text.AppendLine();

        text.AppendLine("CUSTOMER INFORMATION");
        text.AppendLine("--------------------------------------------------------------------------------");
        text.AppendLine($"Company:         {Quote.Company}");
        text.AppendLine($"Contact:         {Quote.Contact}");
        text.AppendLine($"Email:           {Quote.Email}");
        if (!string.IsNullOrEmpty(Quote.Phone))
            text.AppendLine($"Phone:           {Quote.Phone}");
        text.AppendLine($"Systems Needed:  {Quote.Quantity}");
        text.AppendLine();

        if (!string.IsNullOrEmpty(Quote.Notes))
        {
            text.AppendLine("ADDITIONAL NOTES");
            text.AppendLine("--------------------------------------------------------------------------------");
            text.AppendLine(Quote.Notes);
            text.AppendLine();
        }

        text.AppendLine("SYSTEM CONFIGURATION");
        text.AppendLine("--------------------------------------------------------------------------------");
        text.AppendLine($"Type:            {ConveyorType.ToUpper()}");

        if (OverheadConfig != null)
        {
            text.AppendLine($"Track Length:    {OverheadConfig.TrackLength:N0} mm");
            text.AppendLine($"Track Profile:   {OverheadConfig.TrackProfile}");
            text.AppendLine($"Height:          {OverheadConfig.HeightFromFloor:N0} mm");
            text.AppendLine($"Carriers:        {OverheadConfig.NumCarriers} units");
            text.AppendLine($"Carrier Spacing: {OverheadConfig.CarrierSpacing:N0} mm");
            text.AppendLine($"Load/Carrier:    {OverheadConfig.LoadPerCarrier:N0} kg");
            text.AppendLine($"Total Capacity:  {OverheadConfig.NumCarriers * OverheadConfig.LoadPerCarrier:N0} kg");
            text.AppendLine($"Drive Units:     {OverheadConfig.DriveUnits}");

            if (OverheadConfig.IncludeCurves)
            {
                text.AppendLine($"Includes Curves: Yes");
                text.AppendLine($"Curve Radius:    {OverheadConfig.CurveRadius:N0} mm");
            }
            else
            {
                text.AppendLine($"Includes Curves: No");
            }

            if (OverheadConfig.InclineAngle > 0)
                text.AppendLine($"Incline Angle:   {OverheadConfig.InclineAngle}°");
            if (OverheadConfig.DeclineAngle > 0)
                text.AppendLine($"Decline Angle:   {OverheadConfig.DeclineAngle}°");
        }
        text.AppendLine();

        if (BomItems != null && BomItems.Any())
        {
            text.AppendLine("BILL OF MATERIALS");
            text.AppendLine("================================================================================");
            text.AppendLine($"{"Part Number",-20} {"Description",-35} {"Qty",5} {"Price",12} {"Total",12}");
            text.AppendLine("--------------------------------------------------------------------------------");

            foreach (var item in BomItems.Where(i => i.Quantity > 0))
            {
                text.AppendLine($"{item.PartNumber,-20} {item.Description,-35} {item.Quantity,5} {item.UnitPrice,12:C} {item.TotalPrice,12:C}");
            }

            text.AppendLine("--------------------------------------------------------------------------------");
            var total = BomItems.Sum(i => i.TotalPrice);
            text.AppendLine($"{"ESTIMATED TOTAL",62} {total,12:C}");
            text.AppendLine("================================================================================");
        }

        text.AppendLine();
        text.AppendLine("Note: This is an estimate only. Final pricing subject to confirmation.");
        text.AppendLine("Please contact us for detailed specifications and formal quotation.");

        return text.ToString();
    }
}
