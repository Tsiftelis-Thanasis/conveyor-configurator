@using frontend.Models

<div class="modal-overlay" @onclick="OnClose">
    <div class="modal-content" @onclick:stopPropagation="true">
        <header class="modal-header">
            <h2>Request a Quote</h2>
            <button class="close-btn" @onclick="OnClose">&times;</button>
        </header>

        <form @onsubmit="HandleSubmit" @onsubmit:preventDefault>
            <div class="form-group">
                <label for="company">Company Name *</label>
                <input type="text" id="company" @bind="Quote.Company" required />
            </div>

            <div class="form-group">
                <label for="contact">Contact Name *</label>
                <input type="text" id="contact" @bind="Quote.Contact" required />
            </div>

            <div class="form-group">
                <label for="email">Email Address *</label>
                <input type="email" id="email" @bind="Quote.Email" required />
            </div>

            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" @bind="Quote.Phone" />
            </div>

            <div class="form-group">
                <label for="quantity">Number of Systems</label>
                <input type="number" id="quantity" min="1" @bind="Quote.Quantity" />
            </div>

            <div class="form-group">
                <label for="notes">Additional Notes</label>
                <textarea id="notes" rows="3" @bind="Quote.Notes"></textarea>
            </div>

            <div class="quote-summary">
                <h3>Configuration Summary</h3>
                @if (OverheadConfig != null)
                {
                    <dl>
                        <dt>Track Length</dt><dd>@OverheadConfig.TrackLength mm</dd>
                        <dt>Profile</dt><dd>@OverheadConfig.TrackProfile</dd>
                        <dt>Height</dt><dd>@OverheadConfig.HeightFromFloor mm</dd>
                        <dt>Carriers</dt><dd>@OverheadConfig.NumCarriers units</dd>
                        <dt>Load per Carrier</dt><dd>@OverheadConfig.LoadPerCarrier kg</dd>
                        <dt>Total Capacity</dt><dd>@(OverheadConfig.NumCarriers * OverheadConfig.LoadPerCarrier) kg</dd>
                        @if (OverheadConfig.IncludeCurves)
                        {
                            <dt>Curves</dt><dd>R@(OverheadConfig.CurveRadius)mm</dd>
                        }
                    </dl>
                }
            </div>

            @if (BomItems != null && BomItems.Any())
            {
                <div class="quote-summary">
                    <h3>Parts Summary (@BomItems.Count items)</h3>
                    <dl>
                        @foreach (var item in BomItems.Where(i => i.Quantity > 0))
                        {
                            <dt>@item.Description</dt>
                            <dd>@item.Quantity x @item.UnitPrice.ToString("C")</dd>
                        }
                        <dt><strong>Estimated Total</strong></dt>
                        <dd><strong>@BomItems.Sum(i => i.TotalPrice).ToString("C")</strong></dd>
                    </dl>
                </div>
            }

            <div class="modal-actions">
                <button type="button" class="btn-secondary" @onclick="OnClose">Cancel</button>
                <button type="submit" class="btn-primary" disabled="@IsSubmitting">
                    @if (IsSubmitting)
                    {
                        <span>Submitting...</span>
                    }
                    else
                    {
                        <span>Submit Quote Request</span>
                    }
                </button>
            </div>
        </form>
    </div>
</div>

@code {
    [Parameter] public string ConveyorType { get; set; } = "overhead";
    [Parameter] public OverheadConveyorConfig? OverheadConfig { get; set; }
    [Parameter] public List<BomItem>? BomItems { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<QuoteRequest> OnSubmit { get; set; }

    private QuoteRequest Quote { get; set; } = new();
    private bool IsSubmitting { get; set; }

    private async Task HandleSubmit()
    {
        IsSubmitting = true;
        try
        {
            Quote.ConveyorType = ConveyorType;
            Quote.OverheadConfiguration = OverheadConfig;
            Quote.BomItems = BomItems;

            await OnSubmit.InvokeAsync(Quote);
        }
        finally
        {
            IsSubmitting = false;
        }
    }
}
